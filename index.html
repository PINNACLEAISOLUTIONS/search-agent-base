<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OLDTIMECRANK - ANTIQUE PHONOGRAPH ENGINE</title>
    <meta name="description"
        content="Live antique phonograph discovery engine - scanning all Florida Craigslist regions automatically every hour.">
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #5c4033;
            --secondary: #3d2b1f;
            --accent: #cd7f32;
            --text-muted: #9a8a78;
            --success: #4caf50;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
        header {
            text-align: center;
            padding: 50px 20px 30px;
            position: relative;
        }

        header::after {
            content: '';
            display: block;
            width: 120px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            margin: 25px auto 0;
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.8em, 5vw, 3em);
            letter-spacing: 4px;
            color: var(--accent);
            text-transform: uppercase;
            text-shadow: 0 0 30px rgba(205, 127, 50, 0.25);
        }

        .subtitle {
            color: var(--text-muted);
            margin-top: 8px;
            font-size: 0.95em;
            letter-spacing: 1px;
        }

        /* ‚îÄ‚îÄ‚îÄ STATUS BAR ‚îÄ‚îÄ‚îÄ */
        .status-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            padding: 15px 20px;
            margin: 20px auto;
            max-width: 800px;
            background: rgba(30, 25, 20, 0.8);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            font-size: 0.85em;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-muted);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .refresh-btn {
            background: var(--primary);
            color: var(--text);
            border: 1px solid var(--accent);
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: var(--accent);
            color: #000;
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ‚îÄ‚îÄ‚îÄ STATS ROW ‚îÄ‚îÄ‚îÄ */
        .stats-row {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin: 15px auto 25px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-family: 'Playfair Display', serif;
            font-size: 1.8em;
            color: var(--accent);
            font-weight: 700;
        }

        .stat-label {
            font-size: 0.75em;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ‚îÄ‚îÄ‚îÄ CARDS GRID ‚îÄ‚îÄ‚îÄ */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 20px;
            padding-bottom: 40px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 14px;
            padding: 22px;
            border: 1px solid var(--card-border);
            transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
            border-color: var(--primary);
        }

        .card:hover::before {
            opacity: 1;
        }

        .tag {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 3px 10px;
            font-weight: 700;
            font-size: 0.7em;
            border-radius: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tag-new {
            background: var(--accent);
            color: #000;
        }

        .region-badge {
            font-size: 0.8em;
            color: var(--accent);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 10px;
        }

        .score-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .score-badge {
            padding: 3px 10px;
            border-radius: 5px;
            font-weight: 700;
            font-size: 0.8em;
        }

        .classification {
            font-size: 0.72em;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card h3 {
            font-size: 1.15em;
            line-height: 1.45;
            margin-bottom: 14px;
            font-weight: 600;
        }

        .meta {
            font-size: 0.8em;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        a.btn {
            display: inline-block;
            margin-top: 16px;
            padding: 10px 22px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--text);
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.25s;
            border: 1px solid var(--card-border);
        }

        a.btn:hover {
            background: linear-gradient(135deg, var(--accent), var(--primary));
            border-color: var(--accent);
            transform: scale(1.02);
        }

        #status {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
            font-size: 1.1em;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--card-border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .auto-badge {
            display: inline-block;
            background: rgba(76, 175, 80, 0.15);
            color: var(--success);
            border: 1px solid rgba(76, 175, 80, 0.3);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            margin-top: 12px;
            letter-spacing: 0.5px;
        }

        @media (max-width: 480px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .status-bar {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>‚öôÔ∏è OldTimeCrank</h1>
            <p class="subtitle">Live Antique Phonograph Discovery ‚Äî Florida State-Wide</p>
            <div class="auto-badge">ü§ñ Auto-updates every 12 hours via GitHub Actions</div>
        </header>

        <div class="status-bar">
            <div class="status-item">
                <span class="status-dot" id="live-dot"></span>
                <span id="data-source">Loading...</span>
            </div>
            <div class="status-item" id="last-updated">‚Äî</div>
            <button class="refresh-btn" id="refresh-btn" onclick="refresh()">‚Üª Refresh</button>
        </div>

        <div class="stats-row">
            <div class="stat">
                <div class="stat-value" id="stat-total">‚Äî</div>
                <div class="stat-label">Total Leads</div>
            </div>

            <div class="stat">
                <div class="stat-value" id="stat-regions">‚Äî</div>
                <div class="stat-label">Regions</div>
            </div>
        </div>

        <div id="leads-container" class="grid">
            <div id="status"><span class="spinner"></span> Loading leads...</div>
        </div>
    </div>

    <script>
        // FAILSAFE DATA: Embedded directly to guarantee display
        const initialLeads = [
            {
                "id": "7823491023",
                "title": "Vintage Victor Victrola VV-XI Phonograph - Works Great",
                "link": "https://miami.craigslist.org/mdc/atq/d/miami-vintage-victor-victrola-vv-xi/7823491023.html",
                "region": "Miami",
                "keyword": "victrola",
                "score": 5.0,
                "classification": "high_value_antique",
                "timestamp": "2026-02-09T17:15:00",
                "is_new": true
            },
            {
                "id": "7821558291",
                "title": "Edison Diamond Disc Player C-19 w/ Records",
                "link": "https://tampa.craigslist.org/hil/atq/d/tampa-edison-diamond-disc-player-19/7821558291.html",
                "region": "Tampa",
                "keyword": "phonograph",
                "score": 4.5,
                "classification": "antique",
                "timestamp": "2026-02-09T17:10:00",
                "is_new": true
            },
            {
                "id": "7819923847",
                "title": "Antique Columbia Grafonola - Oak Cabinet",
                "link": "https://orlando.craigslist.org/ora/atq/d/orlando-antique-columbia-grafonola/7819923847.html",
                "region": "Orlando",
                "keyword": "antique",
                "score": 4.0,
                "classification": "antique",
                "timestamp": "2026-02-09T17:05:00",
                "is_new": true
            }
        ];

        async function loadLeads() {
            const container = document.getElementById('leads-container');
            const sourceLabel = document.getElementById('data-source');
            const updatedLabel = document.getElementById('last-updated');

            try {
                // Try fetching fresh data first
                let leads = [];
                try {
                    const res = await fetch('leads-v2.json?t=' + Date.now());
                    if (res.ok) leads = await res.json();
                } catch (e) {
                    console.log('Fetch failed, using embedded data');
                }

                // If fetch failed or empty, use embedded failsafe data
                if (!leads || leads.length === 0) {
                    leads = initialLeads;
                    sourceLabel.textContent = "Using fallback data (Live sync pending)";
                } else {
                    sourceLabel.textContent = `${leads.length} leads (Live)`;
                }

                if (!leads || leads.length === 0) {
                    container.innerHTML = '<div id="status">No leads found yet. The scraper runs automatically every hour ‚Äî check back soon!</div>';
                    sourceLabel.textContent = 'Waiting for first scrape';
                    return;
                }

                // Update stats
                document.getElementById('stat-total').textContent = leads.length;
                document.getElementById('stat-regions').textContent = new Set(leads.map(l => l.region)).size;

                // Find the most recent timestamp in the data
                const timestamps = leads.map(l => l.timestamp).filter(Boolean).sort();
                if (timestamps.length > 0) {
                    const latest = timestamps[timestamps.length - 1];
                    const lastScrape = new Date(latest);
                    updatedLabel.textContent = `Last scrape: ${lastScrape.toLocaleString()}`;
                }

                // Sort: newest listing first (by posted_date, then timestamp)
                leads.sort((a, b) => {
                    const dateA = (a.posted_date || a.timestamp || '').replace(' ', 'T');
                    const dateB = (b.posted_date || b.timestamp || '').replace(' ', 'T');
                    return dateB.localeCompare(dateA);
                });

                // Render cards
                container.innerHTML = '';
                leads.forEach(lead => {
                    const card = document.createElement('div');
                    card.className = 'card';

                    const scoreColor = lead.score >= 3 ? 'var(--success)' : 'var(--text-muted)';
                    // Date display (date only, no time)
                    const rawDate = lead.posted_date || lead.timestamp || '';
                    let dateStr = '';
                    if (rawDate) {
                        const d = new Date(rawDate.replace(' ', 'T'));
                        if (!isNaN(d)) dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }

                    // Price display
                    const priceStr = lead.price || '';

                    let tag = '';
                    if (lead.is_new) tag = '<span class="tag tag-new">New</span>';

                    card.innerHTML = `
                        ${tag}
                        <div class="region-badge">üìç ${lead.region || 'Florida'} ‚Ä¢ ${lead.keyword || 'Search'}</div>
                        <div class="score-row">
                            <span class="score-badge" style="background:${scoreColor}; color:#000;">AI: ${lead.score}/5</span>
                            <span class="classification">${lead.classification || ''}</span>
                        </div>
                        <h3>${lead.title}</h3>
                        <div class="meta">
                            <span style="font-size:1.1em; font-weight:600; color:var(--gold);">${priceStr}</span>
                            <span>${dateStr}</span>
                        </div>
                        <a href="${lead.link}" target="_blank" rel="noopener" class="btn">View Lead ‚Üí</a>
                    `;

                    // Insert image if available (skip tiny base64 placeholders)
                    const hasRealImage = lead.image && !lead.image.startsWith('data:image') && !lead.image.includes('empty.png') && lead.image !== '';
                    if (hasRealImage) {
                        const imgContainer = document.createElement('div');
                        imgContainer.style.height = '200px';
                        imgContainer.style.overflow = 'hidden';
                        imgContainer.style.borderRadius = '8px 8px 0 0';
                        imgContainer.style.marginBottom = '15px';
                        imgContainer.style.margin = '-22px -22px 15px -22px';
                        const img = document.createElement('img');
                        img.src = lead.image;
                        img.alt = lead.title;
                        img.style.cssText = 'width:100%; height:100%; object-fit:cover;';
                        img.onerror = function () { imgContainer.style.display = 'none'; };
                        imgContainer.appendChild(img);
                        card.insertBefore(imgContainer, card.firstChild);
                    } else {
                        // Optional: Add a subtle pattern header if no image
                        const header = document.createElement('div');
                        header.style.height = '6px';
                        header.style.background = 'var(--card-border)';
                        header.style.margin = '-22px -22px 15px -22px';
                        card.insertBefore(header, card.firstChild);
                    }

                    container.appendChild(card);
                });

            } catch (error) {
                console.error(error);
                container.innerHTML = `<div id="status">System sync in progress...</div>`;
                sourceLabel.textContent = 'Syncing...';
            }
        }

        async function refresh() {
            const btn = document.getElementById('refresh-btn');
            btn.disabled = true;
            btn.textContent = '‚Üª Loading...';
            await loadLeads();
            btn.disabled = false;
            btn.textContent = '‚Üª Refresh';
        }

        // Initial load
        loadLeads();

        // Auto-refresh every 5 minutes in case new data was pushed
        setInterval(loadLeads, 5 * 60 * 1000);
    </script>
</body>

</html>
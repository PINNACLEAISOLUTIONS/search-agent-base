// src/functions/utils/browser.mts
import puppeteer from "puppeteer";
import chromium from "@sparticuz/chromium";
var isProduction = !process.env.NETLIFY_DEV;
var localShowBrowser = !isProduction && process.env.NETLIFY_PRERENDER_LOCAL_SHOW_BROWSER?.toLowerCase() === "true";
var _browser = null;
async function getBrowser() {
  if (_browser) {
    try {
      if (!_browser.connected) {
        throw new Error("Browser disconnected");
      }
      await Promise.race([
        _browser.pages(),
        new Promise(
          (_, reject) => setTimeout(() => reject(new Error("Health check timeout")), 2e3)
        )
      ]);
      console.log("Browser health check passed, reusing existing instance");
      return _browser;
    } catch (error) {
      console.log("Browser health check failed, recreating:", error?.message);
      try {
        await _browser.close();
      } catch (closeError) {
        console.log("Failed to close dead browser connection:", closeError?.message);
      }
      _browser = null;
    }
  }
  if (!_browser) {
    if (isProduction) {
      const executablePath = await chromium.executablePath();
      _browser = await puppeteer.launch({
        args: [...chromium.args],
        executablePath
      });
    } else {
      console.log("Local development environment detected, using bundled Chromium");
      _browser = await puppeteer.launch({
        headless: !localShowBrowser,
        args: ["--disable-dev-shm-usage"]
      });
    }
    console.log("New browser instance created");
  }
  return _browser;
}
async function closeBrowser() {
  if (_browser) {
    await _browser.close();
  }
  _browser = null;
}
async function clearStorage(cdpClient, page) {
  await page.evaluate(() => {
    localStorage.clear();
  });
  await cdpClient.send("Network.clearBrowserCookies");
}
export {
  clearStorage,
  closeBrowser,
  getBrowser
};
